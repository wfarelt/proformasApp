{% extends 'core/index.html' %}

{% block title %}Proforma New{% endblock %}
{% load static %}

{% block style %}
<style>
  /* Estilos generales */
  @media print {

    .total {
      visibility: visible;
    }

    .no-mostrar{
      visibility: hidden;
      display: flex;
      align-items: center; /* Alinea verticalmente */
      gap: 10px; /* Espaciado entre los botones */
      flex-wrap: wrap; /* Permite que los botones se ajusten si no hay espacio */
    }

    .productos,
    .productos * {
      visibility: hidden;
    }

    .no-mostrar,
    .productos {
      position: absolute;
      left: 0;
      top: 0;
    }
  }
</style>
{% endblock style %}

{% block content %}
<div class="card">

  <div id="proforma" class="card-header">
    <div class="row">
      <div class="col-md-12">
        <strong>
          <h2>Proforma: {{proforma.id}}</h2>
        </strong>
      </div>
      <div class="col-md-4">
          Cliente: {{proforma.cliente}}
          <a href="{% url 'proforma_add_client' proforma.id %}" class="btn btn-warning btn-sm no-mostrar"><i
          class="fas fa-user-plus"></i></a>
      </div>
      <div class="col-md-4">
          Nit: {{proforma.cliente.nit}}
      </div>
      <div class="col-md-4 text-right">
        <form method="post" action="{% url 'cambiar_fecha_proforma' proforma.id %}" class="d-inline">
          {% csrf_token %}
          <label for="fecha">Fecha:</label>
          <input type="date" id="fecha" name="fecha"
                value="{{ proforma.fecha|date:'Y-m-d' }}"
                class="form-control form-control-sm d-inline-block"
                style="width: 160px;">
          <button type="submit" class="btn btn-primary btn-sm">Actualizar</button>
      </form>
      </div>
    </div>
  </div>
  
  <div class="card-body">

    <!-- Busqueda de kits -->
    <div class="kit-selector mb-3">
        <div class="input-group input-group-sm">
            <select id="kit-select" class="form-control">
                <option value="">-- Selecciona un kit --</option>
                {% for kit in kits %}
                    <option value="{{ kit.id }}">{{ kit.name }} ({{ kit.get_items_count }})</option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-info btn-sm" id="load-kit-btn">
                <i class="fas fa-download"></i> Cargar Kit
            </button>
        </div>
    </div>

    <div id="kit-items-preview" class="alert alert-info d-none" role="alert">
        <h6>Productos del kit:</h6>

        <div class="table-responsive">
            <table class="table table-sm" id="kit-items-table">
                <thead>
                    <tr>
                        <th style="width:30px"><input type="checkbox" id="kit-select-all" title="Seleccionar todo"></th>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th class="text-right">Precio</th>
                    </tr>
                </thead>
                <tbody id="kit-items-list"></tbody>
            </table>
        </div>

        <div class="d-flex gap-2">
            <button type="button" class="btn btn-success btn-sm" id="add-selected-kit-items" 
                    data-proforma-id="{{ proforma.id }}">
                <i class="fas fa-plus"></i> Agregar seleccionados
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="clear-kit-selection">
                <i class="fas fa-eraser"></i> Limpiar selección
            </button>
            <button type="button" class="btn btn-warning btn-sm" id="close-kit-preview">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>
    </div>
    <hr>

    <!-- Busqueda de productos -->
    <div class="productos">
      <h2>PRODUCTOS</h2>
      <form method="get" class="mb-3">
        <div class="input-group input-group-sm">
            <!-- Busqueda de productos por id o por codigo -->
            <select name="tipo_busqueda" class="form-control" style="flex:0 0 25%; max-width:25%; width:25%;">
                <option value="codigo" {% if request.GET.tipo_busqueda == "codigo" %}selected{% endif %}>Código</option>
                <option value="id_producto" {% if request.GET.tipo_busqueda == "id_producto" %}selected{% endif %}>Id</option>
            </select>
            <input type="text" name="q" id="search-field" class="form-control ml-2"
                  placeholder="Buscar..." value="{{ request.GET.q }}">
          <div class="input-group-append">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
        </div>
      </form>
      <br>

      <table class="table table-bordered table-sm">
        <tr class="thead-light">
          <th>Codigo</th>
          <th>Descripcion</th>
          <th>Marca</th>
          <th>Stock</th>
          <th>P.Ref.</th>
          <th style="width: 10px;">Precio</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th></th>
        </tr>
    
        {% for producto in productos_list %}
        <tr>
          <form method="POST" action="{% url 'agregar_producto_a_detalle' %}">
            {% csrf_token %}
            <input type="hidden" name="proforma_id" value="{{ proforma.id }}">
            <input type="hidden" name="producto_id" value="{{ producto.id }}">
            <input type="hidden" name="tipo_busqueda" value="{{ request.GET.tipo_busqueda }}">
            <td>{{ producto.nombre }}</td>
            <td>{{ producto.descripcion }}</td>
            {% if producto.brand == None %}
              <td>--</td>
            {% else %}
              <td>{{ producto.brand.initials }}</td>
            {% endif %}
            
            <td style="text-align: center;">{{ producto.stock }}</td>
            <td style="text-align: right;">{{ producto.latest_price }}</td>
            <td><input type="number" id="precio{{ producto.id}}" name="precio" value="{{producto.precio}}" step="0.01" style="width: 80px; text-align: right;">
            </td> 
            <td><input type="number" id="cantidad{{ producto.id}}" name="cantidad" placeholder="0" style="width: 80px; text-align: right;"></td>
            <td><input type="number" id="subtotal{{ producto.id}}" name="subtotal" value="{{ producto.precio  }}" readonly style="width: 80px; text-align: right;">
            </td>
            <td><button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i></button></td>
          </form>
        </tr>
        {% endfor %}
      </table>
    
        <div class="card-footer justify-content-center d-flex">
          {% if page_obj.has_other_pages %}
          <nav>
            <ul class="pagination">
              
              <!-- Botón Anterior -->
              {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">Anterior</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">Anterior</span></li>
              {% endif %}
              
              <!-- Mostrar primera página -->
              {% if page_obj.number > 3 %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">1</a>
              </li>
              {% if page_obj.number > 4 %}
              <li class="page-item disabled"><span class="page-link">…</span></li>
              {% endif %}
              {% endif %}

              <!-- Rango de páginas cercanas -->
              {% for num in page_obj.paginator.page_range %}
                {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                  {% if num == page_obj.number %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                  {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endif %}
              {% endfor %}

              <!-- Mostrar última página -->
              {% if page_obj.number < page_obj.paginator.num_pages|add:"-2" %}
                {% if page_obj.number < page_obj.paginator.num_pages|add:"-3" %}
                  <li class="page-item disabled"><span class="page-link">…</span></li>
                {% endif %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">{{ page_obj.paginator.num_pages }}</a>
                </li>
              {% endif %}

              <!-- Botón Siguiente -->
              {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">Siguiente</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>

    
    </div>
    <br>
    <hr class="no-mostrar">
    
    <!-- Detalle de productos -->
    <div class="detalle">
      <h2>DETALLE DE PRODUCTOS</h2>
      <table class="table table-sm table-bordered">
        <thead class="thead-light">
          <tr>
            <th>Item</th>
            <th>Producto</th>
            <th>Descripción</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Subtotal</th>
            <th>Ubicación</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for detalle in detalles %}
          <tr data-detalle-id="{{ detalle.id }}">
            <td>{{ forloop.counter }}</td>
            <td>{{ detalle.producto }}</td>
            <td>{{ detalle.producto.descripcion }}</td>
            <td style="text-align: center;">{{ detalle.cantidad }}</td>
            <td style="text-align: right;">{{ detalle.precio_venta }}</td>
            <td style="text-align: right;">{{ detalle.subtotal }}</td>
            <td style="text-align: center;">{{ detalle.producto.location }}</td>
            <td style="text-align: center;">
                <a href="{% url 'editar_cantidad_detalle' detalle.id %}" class="btn btn-warning btn-sm no-mostrar editar-cantidad"><i
                class="fas fa-edit"></i></a> 
                <a href="{% url 'eliminar_producto_a_detalle' detalle.id %}" class="btn btn-danger btn-sm no-mostrar"><i
                  class="fas fa-trash-alt"></i></a></td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5">No se encontraron productos.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Total y descuento - VERSIÓN MEJORADA -->
    <div class="total mt-4">
        <div class="row">
            <!-- Subtotal -->
            <div class="col-md-3">
                <div class="card bg-light border-0">
                    <div class="card-body text-center p-3">
                        <small class="text-muted d-block">Subtotal</small>
                        <h5 id="subtotal-value" class="mb-0">
                            {% if user.company.currency == 'BOB' %}Bs{% elif user.company.currency == 'USD' %}${% else %}€{% endif %} {{ proforma.total|floatformat:2 }}
                        </h5>
                    </div>
                </div>
            </div>

            <!-- Descuento % -->
            <div class="col-md-3">
                <div class="card bg-light border-0">
                    <div class="card-body p-3">
                        <form method="POST" action="{% url 'cambiar_estado_proforma' proforma.id %}" class="d-inline">
                            {% csrf_token %}
                            <label for="discount_percentage" class="small text-muted d-block mb-2">Descuento (%)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" step="0.01" min="0" max="100" 
                                    class="form-control text-center" id="discount_percentage" name="discount_percentage"
                                    value="{{ proforma.discount_percentage|default:0 }}" onchange="this.form.submit()">
                                <span class="input-group-text">%</span>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Monto Descuento -->
            <div class="col-md-3">
                <div class="card bg-light border-0">
                    <div class="card-body text-center p-3">
                        <small class="text-muted d-block">Desc. Monto</small>
                        <h5 id="discount-amount" class="mb-0">
                            {% if user.company.currency == 'BOB' %}Bs{% elif user.company.currency == 'USD' %}${% else %}€{% endif %} {{ proforma.total_descuento|floatformat:2 }}
                        </h5>
                    </div>
                </div>
            </div>

            <!-- Total Final -->
            <div class="col-md-3">
                <div class="card bg-success text-white border-0">
                    <div class="card-body text-center p-3">
                        <small class="d-block">Total Final</small>
                        <h4 id="total-value" class="mb-0">
                            {% if user.company.currency == 'BOB' %}Bs{% elif user.company.currency == 'USD' %}${% else %}€{% endif %} {{ proforma.total_neto|floatformat:2 }}
                        </h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4">

    <!-- Observaciones y estado de la proforma -->
    <form method="POST" action="{% url 'cambiar_estado_proforma' proforma.id %}" class="mt-4">
        {% csrf_token %}
        
        <!-- Observaciones -->
        <div class="form-group mb-3">
            <label for="observacion" class="form-label fw-bold">Observaciones</label>
            <textarea name="observacion" id="observacion" class="form-control form-control-sm" 
                      rows="2" placeholder="Añade observaciones adicionales...">{{ proforma.observacion|default_if_none:'' }}</textarea>
        </div>

        <!-- Estado -->
        <div class="form-check form-check-lg mb-3">
            <input class="form-check-input" type="checkbox" value="EJECUTADO" id="estado" name="estado"
                {% if proforma.estado == 'EJECUTADO' %} checked disabled {% endif %}>
            <label class="form-check-label fw-bold" for="estado">
                Marcar como EJECUTADO
            </label>
            {% if proforma.estado == 'EJECUTADO' %}
                <small class="text-success d-block mt-1">✓ Proforma ejecutada</small>
            {% endif %}
        </div>

        <!-- Botones de acción -->
        <div class="d-flex gap-2 justify-content-between">
            <div>
                <button type="submit" class="btn btn-success btn-sm">
                    <i class="fas fa-check"></i> Guardar
                </button>
                <a href="{% url 'proforma_list' %}" class="btn btn-danger btn-sm">
                    <i class="fas fa-times"></i> Cerrar
                </a>
            </div>
            <div>
                <a href="{% url 'proforma_pdf' proforma.id %}" 
                  target="_blank" rel="noopener noreferrer" class="btn btn-info btn-sm">
                  <i class="fas fa-file-pdf"></i> Sin/Code
                </a>
                <a href="{% url 'proforma_almacen' proforma.id %}" target="_blank" rel="noopener noreferrer" 
                  class="btn btn-secondary btn-sm">
                  <i class="fas fa-file-pdf"></i> Con/Code
                </a>
            </div>
        </div>
    </form>

  </div>

</div>

{% endblock %}

{% block scripts %}
<!-- JavaScript para enfocar el campo de búsqueda -->
<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("search-field").focus();

    
    
    document.querySelectorAll(".editar-cantidad").forEach(btn => {
        btn.addEventListener("click", function (event) {
            event.preventDefault();
            let row = this.closest("tr");
            let cantidadTd = row.querySelector("td:nth-child(4)");
            let precioTd = row.querySelector("td:nth-child(5)");
            
            let cantidadActual = cantidadTd.innerText.trim();
            let precioActual = precioTd.innerText.trim();

            let inputCantidad = document.createElement("input");
            inputCantidad.type = "number";
            inputCantidad.value = cantidadActual;
            inputCantidad.className = "form-control";
            inputCantidad.style.width = "80px";

            let inputPrecio = document.createElement("input");
            inputPrecio.type = "number";
            inputPrecio.step = "0.01";
            inputPrecio.value = precioActual;
            inputPrecio.className = "form-control";
            inputPrecio.style.width = "100px";
            inputPrecio.style.textAlign = "right";

            cantidadTd.innerHTML = "";
            cantidadTd.appendChild(inputCantidad);

            precioTd.innerHTML = "";
            precioTd.appendChild(inputPrecio);

            inputCantidad.focus();

            // Guardado diferido: espera un poco al blur y comprueba el elemento enfocado
            let saveTimeout = null;
            function scheduleSave() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    // Si ninguno de los dos inputs está enfocado, guardamos
                    if (document.activeElement !== inputCantidad && document.activeElement !== inputPrecio) {
                        doSave();
                    }
                }, 120); // pequeño retraso para permitir cambios de foco entre inputs
            }

            function doSave() {
                const cantVal = inputCantidad.value === "" ? null : inputCantidad.value;
                const precVal = inputPrecio.value === "" ? null : inputPrecio.value;
                actualizarCantidadYPrecio(row, cantVal, precVal);
            }

            // Eventos: no guardan inmediatamente al cambiar foco entre los dos inputs
            inputCantidad.addEventListener("blur", scheduleSave);
            inputPrecio.addEventListener("blur", scheduleSave);

            // Si el usuario presiona Enter en cualquiera, guardamos inmediatamente
            inputCantidad.addEventListener("keypress", function (ev) {
                if (ev.key === "Enter") {
                    ev.preventDefault();
                    clearTimeout(saveTimeout);
                    doSave();
                }
            });
            inputPrecio.addEventListener("keypress", function (ev) {
                if (ev.key === "Enter") {
                    ev.preventDefault();
                    clearTimeout(saveTimeout);
                    doSave();
                }
            });

            // Si hace clic fuera de la fila (no en alguno de los inputs), forzamos guardado
            document.addEventListener("click", function docClick(e) {
                if (!row.contains(e.target)) {
                    clearTimeout(saveTimeout);
                    doSave();
                    document.removeEventListener("click", docClick);
                }
            }, { once: true });
        });
    });

    function actualizarCantidadYPrecio(row, nuevaCantidad, nuevoPrecio) {
        let detalleId = row.dataset.detalleId;
        
        fetch(`/editar_cantidad_detalle/${detalleId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ cantidad: nuevaCantidad, precio: nuevoPrecio })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("Error: " + (data.error || "al actualizar"));
                location.reload();
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Error en la petición");
        });
    }

    function getCSRFToken() {
        const el = document.querySelector("[name=csrfmiddlewaretoken]");
        return el ? el.value : "";
    }
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Debug: confirmar que proforma está presente
    console.log('Context proforma:', typeof proforma !== 'undefined' ? proforma : 'proforma var not available');

    const loadBtn = document.getElementById('load-kit-btn');
    const kitSelect = document.getElementById('kit-select');
    const preview = document.getElementById('kit-items-preview');
    const itemsList = document.getElementById('kit-items-list');
    const selectAll = document.getElementById('kit-select-all');
    const addSelectedBtn = document.getElementById('add-selected-kit-items');
    const clearBtn = document.getElementById('clear-kit-selection');

    function getCSRFToken() {
        const el = document.querySelector('[name=csrfmiddlewaretoken]');
        return el ? el.value : '';
    }

    loadBtn.addEventListener('click', function() {
        const kitId = kitSelect.value;
        if (!kitId) {
            alert('Selecciona un kit primero');
            return;
        }

        fetch(`/api/kits/${kitId}/items/`)
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => {
                itemsList.innerHTML = '';
                if (!data.items || data.items.length === 0) {
                    itemsList.innerHTML = '<tr><td colspan="4">No hay productos en este kit.</td></tr>';
                    preview.classList.remove('d-none');
                    return;
                }
                data.items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-center">
                            <input type="checkbox" class="kit-item-checkbox"
                                data-producto-id="${item.producto__id}"
                                data-cantidad="${item.cantidad}"
                                data-precio="${item.producto__precio}">
                        </td>
                        <td>
                            <strong>${item.producto__nombre}</strong>
                            ${item.producto__descripcion ? `<br><small class="text-dark">${item.producto__descripcion}</small>` : ''}
                        </td>
                        <td>${item.cantidad}</td>
                        <td class="text-right">${parseFloat(item.producto__precio).toFixed(2)}</td>
                    `;
                    itemsList.appendChild(tr);
                });
                preview.classList.remove('d-none');
                if (selectAll) selectAll.checked = false;
            })
            .catch(err => {
                console.error('Error cargando items del kit:', err);
                alert('Error al cargar items del kit. Revisa la consola y el endpoint /api/kits/<id>/items/');
            });
    });

    if (selectAll) {
        selectAll.addEventListener('change', function() {
            document.querySelectorAll('.kit-item-checkbox').forEach(cb => cb.checked = this.checked);
        });
    }

    clearBtn.addEventListener('click', function() {
        document.querySelectorAll('.kit-item-checkbox').forEach(cb => cb.checked = false);
        if (selectAll) selectAll.checked = false;
    });

    // Cerrar preview del kit
    const closeBtn = document.getElementById('close-kit-preview');
    closeBtn.addEventListener('click', function() {
        preview.classList.add('d-none');
        kitSelect.value = '';
        itemsList.innerHTML = '';
        if (selectAll) selectAll.checked = false;
    });

    addSelectedBtn.addEventListener('click', function() {
        const checked = Array.from(document.querySelectorAll('.kit-item-checkbox:checked'));
        if (checked.length === 0) {
            alert('Selecciona al menos un producto del kit');
            return;
        }

        // Obtener proformaId del atributo data del botón
        const proformaId = document.getElementById('add-selected-kit-items').dataset.proformaId;
        
        if (!proformaId) {
            alert('No hay proforma disponible en el contexto. Imposible agregar productos.');
            return;
        }

        const csrfToken = getCSRFToken();

        function sendItem(cb) {
            const productoId = cb.dataset.productoId;
            const cantidad = cb.dataset.cantidad;
            const precio = cb.dataset.precio;

            const form = new FormData();
            form.append('proforma_id', proformaId);
            form.append('producto_id', productoId);
            form.append('cantidad', cantidad);
            form.append('precio', precio);
            form.append('tipo_busqueda', 'codigo');
            if (csrfToken) form.append('csrfmiddlewaretoken', csrfToken);

            // Debug: mostrar lo que se envía
            console.log('Enviando item:', { proformaId, productoId, cantidad, precio });

            return fetch('{% url "agregar_producto_a_detalle" %}', {
                method: 'POST',
                body: form
            }).then(resp => {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                return resp.text(); // o json() si el endpoint devuelve json
            });
        }

        (async function() {
            try {
                for (const cb of checked) {
                    await sendItem(cb);
                }
                location.reload();
            } catch (e) {
                console.error('Error al agregar items del kit:', e);
                alert('Ocurrió un error al agregar los productos seleccionados. Revisa la consola y la pestaña Network.');
            }
        })();
    });
});
</script>



{% endblock %}