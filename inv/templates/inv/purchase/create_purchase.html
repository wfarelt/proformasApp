{% extends 'core/index.html' %}

{% block title %}{{title}}{% endblock %}
{% load static %}

{% block style %}
    <link rel="stylesheet" href="{% static 'plugins/select2/css/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
{% endblock %}

{% block content %}

{% if form.instance.pk %}
<h1>Modificar Compra</h1>
<form method="post" action="{% url 'update_purchase' form.instance.pk %}">
    {% else %}
    <h1>Registrar Compra</h1>
    <form method="post" action="{% url 'create_purchase' %}">
        {% endif %}

        {% csrf_token %}
        <div class="card card-dark">
            <div class="card-header">
                <h3 class="card-title">Datos de la Compra</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for field in form %}
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                            <div class="text-danger small">
                                {{ field.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>


        <div class="card">
            <div class="card-header">
                <h4>Detalle de Productos</h4>
                {{ formset.management_form }}
            </div>
            <div class="card-body">
                <div class="table">
                    <table class="table table-bordered table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th class="text-right">Costo ($)</th>
                                <th class="text-right">Subtotal ($)</th>
                                <th class="text-right">Precio Venta ($)</th>
                                <th class="text-center"><i class="fas fa-trash"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for form in formset %}
                            {{ form.id }} <!-- Campo oculto con el ID del objeto (importante) -->
                            <tr>
                                <td>{{ form.product }}</td>
                                <td>{{ form.quantity }}</td>
                                <td>{{ form.unit_price }}</td>
                                <td class="subtotal text-right">
                                    {% if form.instance.pk %}
                                    {{ form.instance.subtotal|floatformat:2 }}
                                    {% else %}
                                    0.00
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.sale_price }}
                                </td>
                                <td class="text-center">
                                    {{ form.DELETE }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">No hay productos en el detalle.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3">
                                    <strong>Total:</strong>
                                </td>
                                <td class="text-right total">{{ purchase.total_amount|floatformat:2 }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="text-center mb-3">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar</button>
                    <a href="{% url 'purchase_list' %}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i>
                        Regresar</a>
                </div>
            </div>
        </div>
    </form>

    {% endblock %}

    {% block scripts %}
    <script src="{% static 'plugins/select2/js/select2.min.js' %}"></script>

    <script>
        $(document).ready(function () {
            $('.select2').select2({
                placeholder: "Seleccione un producto",
                allowClear: true,
                language: "es",  // 游댳 Usa el idioma espa침ol
                minimumInputLength: 1,
                width: '100%',
                theme: 'bootstrap4',
                ajax: {
                    url: '/inv/api/productos/',  // URL de tu API en Django
                    dataType: 'json',
                    delay: 250,  // Retraso para evitar demasiadas peticiones al servidor
                    data: function (params) {
                        return {
                            q: params.term,  // El usuario escribe en el input
                            page: params.page || 1  // Soporte para paginaci칩n
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.results.map(item => ({
                                id: item.id,
                                text: item.nombre
                            })),
                            pagination: {
                                more: data.has_next // Indica si hay m치s p치ginas
                            }
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,  // Buscar despu칠s de 1 car치cter
                width: '100%'
            });

            $(document).on('select2:open', () => {
                document.querySelector('.select2-container--open .select2-search__field').focus();
            });
        });
        
        // Funciones para calcular precio de venta (35%) y subtotales/total
        function parseFloatOrZero(v) {
            var n = parseFloat(String(v).replace(/,/g, ''));
            return isNaN(n) ? 0 : n;
        }

        // unitChanged: true when the unit price was edited (we may auto-calc sale_price)
        function updateRow($row, unitChanged) {
            var unit = parseFloatOrZero($row.find('.unit-price').val());
            var qty = parseFloatOrZero($row.find('.quantity').val());

            // Solo auto-calcular sale_price si la edici칩n vino del unit price
            if (unitChanged) {
                var $saleInput = $row.find('.sale-price');
                var saleCurrent = $saleInput.val();
                var autoAttr = $saleInput.attr('data-auto-calculated');

                // Si est치 vac칤o o fue auto-calculado previamente (no manual), recalculamos
                if (!saleCurrent || autoAttr !== 'false') {
                    var sale = +(unit * 1.35).toFixed(2);
                    $saleInput.val(sale);
                    $saleInput.attr('data-auto-calculated', 'true');
                }
            }

            var subtotal = +(unit * qty || 0).toFixed(2);
            $row.find('.subtotal').text(subtotal.toFixed(2));
        }

        function updateTotal() {
            var total = 0;
            $('table tbody tr').each(function () {
                var st = parseFloatOrZero($(this).find('.subtotal').text());
                total += st;
            });
            $('.total').text(total.toFixed(2));
        }

        // Cuando el usuario edita manualmente el precio de venta, marcamos para no sobreescribir
        $(document).on('input change', '.sale-price', function () {
            $(this).attr('data-auto-calculated', 'false');
        });

        // Escucha cambios separados: si se modifica unit-price recalculamos sale_price (si corresponde)
        $(document).on('input change', '.unit-price', function () {
            var $row = $(this).closest('tr');
            updateRow($row, true);
            updateTotal();
        });

        // Si cambia la cantidad, solo recalculamos subtotal/total, sin tocar sale_price
        $(document).on('input change', '.quantity', function () {
            var $row = $(this).closest('tr');
            updateRow($row, false);
            updateTotal();
        });

        // Al cargar la p치gina solo recalculamos el total (no el sale_price)
        $(document).ready(function () {
            updateTotal();
        });
    </script>
    {% endblock %}