{% extends 'core/index.html' %}

{% block title %}{{ title }}{% endblock %}
{% load static %}
{% block style %}
<link rel="stylesheet" href="{% static 'plugins/select2/css/select2.min.css' %}">
<link rel="stylesheet" href="{% static 'plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
{% endblock %}

{% block content %}
<form method="post" action="{% url 'create_movement' %}">
    {% csrf_token %}
    <div class="card card-dark">
        <div class="card-header">
            <h3 class="card-title">Datos del movimiento</h3>
        </div>
        <div class="card-body">
            <div class="row">
                {% for field in form %}
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger small">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h4>Detalle de Productos</h4>
            {{ formset.management_form }}
        </div>
        <div class="card-body">
            <div class="table">
                <table class="table table-bordered table-striped table-sm">
                    <thead class="thead-dark">
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th class="text-right">Precio Unitario</th>
                            <th class="text-right">Subtotal</th>
                            <th class="text-center"><i class="fas fa-trash"></i></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in formset %}
                        {{ form.id }}
                        <tr>
                            <td>{{ form.product }}</td>
                            <td>{{ form.quantity }}</td>
                            <td class="unit-price text-right">0.00</td>
                            <td class="subtotal text-right">0.00</td>
                            <td class="text-center">{{ form.DELETE }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5">No hay productos en el detalle.</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-right"><strong>Total:</strong></td>
                            <td class="total text-right">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <div class="form-group text-right">
                <button type="submit" class="btn btn-primary">Guardar</button>
                <a href="{% url 'movement_list' %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="{% static 'plugins/select2/js/select2.min.js' %}"></script>

<script>
    $(document).ready(function () {
        $('.select2').select2({
            placeholder: "Seleccione un producto",
            allowClear: true,
            language: "es",
            minimumInputLength: 1,
            width: '100%',
            theme: 'bootstrap4',
            ajax: {
                url: '/inv/api/productos/',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term,
                        page: params.page || 1
                    };
                },
                processResults: function (data, params) {
                    return {
                        results: data.results.map(item => ({ id: item.id, text: item.nombre })),
                        pagination: { more: data.has_next }
                    };
                },
                cache: true
            }
        });

        $(document).on('select2:open', () => {
            document.querySelector('.select2-container--open .select2-search__field').focus();
        });

        function updateSubtotals() {
            let totalGeneral = 0;
            $('table tbody tr').each(function () {
                const row = $(this);
                const productSelect = row.find('select');
                const quantityInput = row.find('input[name$="quantity"]');
                const unitPriceCell = row.find('.unit-price');
                const subtotalCell = row.find('.subtotal');

                const productId = productSelect.val();
                const quantity = parseFloat(quantityInput.val()) || 0;

                if (productId && quantity > 0) {
                    $.get(`/inv/api/producto/${productId}/`, function (data) {
                        const cost = parseFloat(data.cost) || 0;
                        const subtotal = cost * quantity;

                        unitPriceCell.text(cost.toFixed(2));
                        subtotalCell.text(subtotal.toFixed(2));

                        // Sumar al total general
                        totalGeneral += subtotal;

                        // Actualizar total al final
                        $('.total').text(totalGeneral.toFixed(2));
                    });
                } else {
                    unitPriceCell.text("0.00");
                    subtotalCell.text("0.00");
                }
            });
        }

        $(document).on('change', 'select, input[name$="quantity"]', updateSubtotals);
        updateSubtotals();
    });
</script>
{% endblock %}
